package pbconv

import (
	goproto "github.com/golang/protobuf/proto"
	"github.com/josudoey/go-pbconv/internal/fixture"
	. "github.com/onsi/ginkgo"
	. "github.com/onsi/gomega"
	"google.golang.org/protobuf/types/descriptorpb"
	"google.golang.org/protobuf/types/known/emptypb"
)

var _ = Describe("GetFileDescriptorProtoByRaw", func() {
	var (
		rawDesc []byte

		file *descriptorpb.FileDescriptorProto
		err  error
	)

	BeforeEach(func() {
		// ref https://github.com/golang/protobuf/blob/5d5e8c018a13017f9d5b8bf4fad64aaa42a87308/ptypes/empty/empty.pb.go#L19C1-L19C1
		// empty_proto_rawDesc
		rawDesc = []byte{
			0x0a, 0x33, 0x67, 0x69, 0x74, 0x68, 0x75, 0x62, 0x2e, 0x63, 0x6f, 0x6d, 0x2f, 0x67, 0x6f, 0x6c,
			0x61, 0x6e, 0x67, 0x2f, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x62, 0x75, 0x66, 0x2f, 0x70, 0x74, 0x79,
			0x70, 0x65, 0x73, 0x2f, 0x65, 0x6d, 0x70, 0x74, 0x79, 0x2f, 0x65, 0x6d, 0x70, 0x74, 0x79, 0x2e,
			0x70, 0x72, 0x6f, 0x74, 0x6f, 0x1a, 0x1b, 0x67, 0x6f, 0x6f, 0x67, 0x6c, 0x65, 0x2f, 0x70, 0x72,
			0x6f, 0x74, 0x6f, 0x62, 0x75, 0x66, 0x2f, 0x65, 0x6d, 0x70, 0x74, 0x79, 0x2e, 0x70, 0x72, 0x6f,
			0x74, 0x6f, 0x42, 0x2f, 0x5a, 0x2d, 0x67, 0x69, 0x74, 0x68, 0x75, 0x62, 0x2e, 0x63, 0x6f, 0x6d,
			0x2f, 0x67, 0x6f, 0x6c, 0x61, 0x6e, 0x67, 0x2f, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x62, 0x75, 0x66,
			0x2f, 0x70, 0x74, 0x79, 0x70, 0x65, 0x73, 0x2f, 0x65, 0x6d, 0x70, 0x74, 0x79, 0x3b, 0x65, 0x6d,
			0x70, 0x74, 0x79, 0x50, 0x00, 0x62, 0x06, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x33,
		}
	})

	JustBeforeEach(func() {
		file, err = GetFileDescriptorProtoByRaw(rawDesc)
	})

	It("success", func() {
		Expect(err).To(Succeed())
		Expect(file).ToNot(BeNil())
		Expect(file.GetName()).To(Equal("github.com/golang/protobuf/ptypes/empty/empty.proto"))
		Expect(file.GetOptions().GetGoPackage()).To(Equal("github.com/golang/protobuf/ptypes/empty;empty"))
	})
})

var _ = Describe("GetFileDescriptorProtoByFilename", func() {
	var (
		_ = fixture.File_internal_fixture_file_proto

		filename string

		file *descriptorpb.FileDescriptorProto
		err  error
	)

	BeforeEach(func() {
		filename = "internal/fixture/file.proto"
	})

	JustBeforeEach(func() {
		file, err = GetFileDescriptorProtoByFilename(filename)
	})

	It("success", func() {
		Expect(err).To(Succeed())
		Expect(file).ToNot(BeNil())

		Expect(file.GetPackage()).To(Equal("pbconv.intenal.fixture"))
		Expect(file.GetOptions().GetGoPackage()).To(Equal("github.com/josudoey/go-pbconv/internal/fixture"))
	})
})

var _ = Describe("GetFileDescriptorProtoByMessage", func() {
	var (
		message goproto.Message

		file *descriptorpb.FileDescriptorProto
		err  error
	)

	JustBeforeEach(func() {
		file, err = GetFileDescriptorProtoByMessage(message)
	})

	Context("empty.Empty", func() {
		BeforeEach(func() {
			message = (*emptypb.Empty)(nil)
		})

		It("success", func() {
			Expect(err).To(Succeed())
			Expect(file.GetName()).To(Equal("google/protobuf/empty.proto"))
			Expect(file.GetOptions().GetGoPackage()).To(Equal("google.golang.org/protobuf/types/known/emptypb"))

			// ref https://github.com/protocolbuffers/protobuf-go/blob/6d0a5dbd95005b70501b4cc2c5124dab07a1f4a0/types/known/emptypb/empty.pb.go#L90C1-L90C1
			rawDesc, err := goproto.Marshal(file)
			Expect(err).To(Succeed())
			Expect(rawDesc).To(BeComparableTo([]byte{
				0x0a, 0x1b, 0x67, 0x6f, 0x6f, 0x67, 0x6c, 0x65, 0x2f, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x62, 0x75,
				0x66, 0x2f, 0x65, 0x6d, 0x70, 0x74, 0x79, 0x2e, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x12, 0x0f, 0x67,
				0x6f, 0x6f, 0x67, 0x6c, 0x65, 0x2e, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x62, 0x75, 0x66, 0x22, 0x07,
				0x0a, 0x05, 0x45, 0x6d, 0x70, 0x74, 0x79, 0x42, 0x7d, 0x0a, 0x13, 0x63, 0x6f, 0x6d, 0x2e, 0x67,
				0x6f, 0x6f, 0x67, 0x6c, 0x65, 0x2e, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x62, 0x75, 0x66, 0x42, 0x0a,
				0x45, 0x6d, 0x70, 0x74, 0x79, 0x50, 0x72, 0x6f, 0x74, 0x6f, 0x50, 0x01, 0x5a, 0x2e, 0x67, 0x6f,
				0x6f, 0x67, 0x6c, 0x65, 0x2e, 0x67, 0x6f, 0x6c, 0x61, 0x6e, 0x67, 0x2e, 0x6f, 0x72, 0x67, 0x2f,
				0x70, 0x72, 0x6f, 0x74, 0x6f, 0x62, 0x75, 0x66, 0x2f, 0x74, 0x79, 0x70, 0x65, 0x73, 0x2f, 0x6b,
				0x6e, 0x6f, 0x77, 0x6e, 0x2f, 0x65, 0x6d, 0x70, 0x74, 0x79, 0x70, 0x62, 0xf8, 0x01, 0x01, 0xa2,
				0x02, 0x03, 0x47, 0x50, 0x42, 0xaa, 0x02, 0x1e, 0x47, 0x6f, 0x6f, 0x67, 0x6c, 0x65, 0x2e, 0x50,
				0x72, 0x6f, 0x74, 0x6f, 0x62, 0x75, 0x66, 0x2e, 0x57, 0x65, 0x6c, 0x6c, 0x4b, 0x6e, 0x6f, 0x77,
				0x6e, 0x54, 0x79, 0x70, 0x65, 0x73, 0x62, 0x06, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x33,
			}))
		})
	})
})
